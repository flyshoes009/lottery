# ğŸ”’ å¹¶å‘æ§åˆ¶æœºåˆ¶

## ğŸš¨ å¹¶å‘é—®é¢˜åˆ†æ

### åŸæœ‰é—®é¢˜
åœ¨å¤šäººåŒæ—¶æŠ½ç­¾æ—¶ï¼ŒåŸæœ‰ä»£ç å­˜åœ¨ä¸¥é‡çš„ç«æ€æ¡ä»¶ï¼š

```
ç”¨æˆ·A: è¯»å–çŠ¶æ€ â†’ å¯ç”¨å·ç [1,2,3] â†’ é€‰æ‹©å·ç 2 â†’ å‡†å¤‡ä¿å­˜
ç”¨æˆ·B: è¯»å–çŠ¶æ€ â†’ å¯ç”¨å·ç [1,2,3] â†’ é€‰æ‹©å·ç 2 â†’ å…ˆä¿å­˜æˆåŠŸ  
ç”¨æˆ·A: ä¿å­˜çŠ¶æ€ â†’ è¦†ç›–ç”¨æˆ·Bçš„æ•°æ® â†’ å·ç 2è¢«é‡å¤åˆ†é…
```

## âœ… è§£å†³æ–¹æ¡ˆ

### 1. ä¹è§‚é”æœºåˆ¶
ä½¿ç”¨ç‰ˆæœ¬å·è¿›è¡Œä¹è§‚é”æ§åˆ¶ï¼š
- æ¯æ¬¡è¯»å–æ—¶è·å–å½“å‰ç‰ˆæœ¬å·
- ä¿å­˜æ—¶æ£€æŸ¥ç‰ˆæœ¬å·æ˜¯å¦å‘ç”Ÿå˜åŒ–
- å¦‚æœç‰ˆæœ¬å·æ”¹å˜ï¼Œè¯´æ˜æœ‰å…¶ä»–ç”¨æˆ·å·²ç»ä¿®æ”¹æ•°æ®

### 2. åŸå­æ€§æ“ä½œ
```javascript
// åŸå­æ€§ä¿å­˜å‡½æ•°
async function atomicSaveState(newState, expectedVersion) {
    // 1. æ£€æŸ¥ç‰ˆæœ¬å·
    const currentState = await readState();
    if (currentState.version !== expectedVersion) {
        return { success: false, conflict: true };
    }
    
    // 2. åŸå­æ€§å†™å…¥
    const response = await fetch(FIREBASE_URL, {
        method: 'PUT',
        body: JSON.stringify({
            ...newState,
            version: expectedVersion + 1
        })
    });
    
    return { success: response.ok };
}
```

### 3. é‡è¯•æœºåˆ¶
- æœ€å¤§é‡è¯•æ¬¡æ•°ï¼š3æ¬¡
- éšæœºå»¶è¿Ÿï¼š100-150ms
- æŒ‡æ•°é€€é¿ï¼šé¿å…é›·ç¾¤æ•ˆåº”

### 4. å¹¶å‘æ§åˆ¶æµç¨‹

```mermaid
graph TD
    A[å¼€å§‹æŠ½ç­¾] --> B[è¯»å–å½“å‰çŠ¶æ€]
    B --> C[æ£€æŸ¥å¯ç”¨å·ç ]
    C --> D{æ˜¯å¦æœ‰å¯ç”¨å·ç ?}
    D -->|å¦| E[è¿”å›å·²æŠ½å®Œ]
    D -->|æ˜¯| F[éšæœºé€‰æ‹©å·ç ]
    F --> G[å°è¯•åŸå­æ€§ä¿å­˜]
    G --> H{ä¿å­˜æˆåŠŸ?}
    H -->|æ˜¯| I[è¿”å›æˆåŠŸç»“æœ]
    H -->|å¦| J{æ˜¯å¦ç‰ˆæœ¬å†²çª?}
    J -->|æ˜¯| K{é‡è¯•æ¬¡æ•°<3?}
    K -->|æ˜¯| L[å»¶è¿Ÿåé‡è¯•]
    L --> B
    K -->|å¦| M[è¿”å›æœåŠ¡ç¹å¿™]
    J -->|å¦| N[è¿”å›ä¿å­˜å¤±è´¥]
```

## ğŸ”§ æ ¸å¿ƒæ”¹è¿›

### 1. ç‰ˆæœ¬æ§åˆ¶
```javascript
// æ•°æ®ç»“æ„æ·»åŠ ç‰ˆæœ¬å·
{
  "drawnNumbers": [1, 5, 12],
  "participants": [...],
  "version": 15,        // ç‰ˆæœ¬å·
  "lastUpdate": "..."   // æœ€åæ›´æ–°æ—¶é—´
}
```

### 2. å†²çªæ£€æµ‹
```javascript
// æ£€æµ‹å¹¶å‘å†²çª
if (currentState.version !== expectedVersion) {
    console.log(`ç‰ˆæœ¬å†²çª: æœŸæœ›=${expectedVersion}, å®é™…=${currentState.version}`);
    return { success: false, conflict: true };
}
```

### 3. æ™ºèƒ½é‡è¯•
```javascript
// å¸¦éšæœºå»¶è¿Ÿçš„é‡è¯•æœºåˆ¶
for (let attempt = 1; attempt <= MAX_RETRY_ATTEMPTS; attempt++) {
    const result = await performDraw();
    if (result.success) return result;
    
    if (result.conflict && attempt < MAX_RETRY_ATTEMPTS) {
        // éšæœºå»¶è¿Ÿé¿å…åŒæ—¶é‡è¯•
        await delay(RETRY_DELAY_MS + Math.random() * 50);
        continue;
    }
}
```

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### 1. å‡å°‘ç½‘ç»œè¯·æ±‚
- åœ¨ä¸€æ¬¡äº‹åŠ¡ä¸­å®Œæˆè¯»å–-æ£€æŸ¥-å†™å…¥
- é¿å…ä¸å¿…è¦çš„çŠ¶æ€æŸ¥è¯¢

### 2. æ™ºèƒ½é€€é¿
- ç¬¬1æ¬¡é‡è¯•ï¼š100-150mså»¶è¿Ÿ
- ç¬¬2æ¬¡é‡è¯•ï¼š150-200mså»¶è¿Ÿ
- ç¬¬3æ¬¡é‡è¯•ï¼š200-250mså»¶è¿Ÿ

### 3. é”™è¯¯åˆ†ç±»å¤„ç†
```javascript
// ä¸åŒé”™è¯¯ç±»å‹çš„çŠ¶æ€ç 
switch (errorCode) {
    case 'LOTTERY_FULL': return 400;     // å®¢æˆ·ç«¯é”™è¯¯
    case 'MAX_RETRIES_EXCEEDED': return 503; // æœåŠ¡ä¸å¯ç”¨
    case 'SAVE_FAILED': return 500;      // æœåŠ¡å™¨é”™è¯¯
}
```

## ğŸ§ª æµ‹è¯•åœºæ™¯

### å¹¶å‘æµ‹è¯•ç”¨ä¾‹
1. **åŒäººåŒæ—¶æŠ½ç­¾** - ç¡®ä¿ä¸ä¼šæŠ½åˆ°ç›¸åŒå·ç 
2. **å¤šäººå¿«é€Ÿè¿ç»­æŠ½ç­¾** - éªŒè¯é‡è¯•æœºåˆ¶
3. **ç½‘ç»œå»¶è¿Ÿæƒ…å†µ** - æ¨¡æ‹Ÿæ…¢ç½‘ç»œç¯å¢ƒ
4. **è¾¹ç•Œæ¡ä»¶** - æœ€åä¸€ä¸ªå·ç çš„å¹¶å‘æŠ½å–

### é¢„æœŸè¡Œä¸º
- âœ… ç»ä¸å‡ºç°é‡å¤å·ç 
- âœ… é«˜å¹¶å‘ä¸‹ç³»ç»Ÿç¨³å®š
- âœ… é€‚å½“çš„ç”¨æˆ·åé¦ˆï¼ˆé‡è¯•æç¤ºï¼‰
- âœ… ä¼˜é›…çš„é”™è¯¯å¤„ç†

## âš¡ ç”¨æˆ·ä½“éªŒ

### æˆåŠŸæƒ…å†µ
```json
{
  "success": true,
  "number": 5,
  "message": "æŠ½ç­¾æˆåŠŸï¼ˆç»è¿‡2æ¬¡å°è¯•ï¼‰",
  "attempts": 2
}
```

### å†²çªæƒ…å†µ  
```json
{
  "success": false,
  "message": "æœåŠ¡å™¨ç¹å¿™ï¼Œè¯·ç¨åé‡è¯•",
  "code": "MAX_RETRIES_EXCEEDED"
}
```

## ğŸ¯ æ€»ç»“

é€šè¿‡å®æ–½ä»¥ä¸Šå¹¶å‘æ§åˆ¶æœºåˆ¶ï¼š

1. **æ•°æ®ä¸€è‡´æ€§** - æœç»é‡å¤æŠ½å·é—®é¢˜
2. **ç³»ç»Ÿç¨³å®šæ€§** - é«˜å¹¶å‘ä¸‹æ­£å¸¸å·¥ä½œ
3. **ç”¨æˆ·ä½“éªŒ** - é€æ˜çš„é‡è¯•æœºåˆ¶
4. **å¯æ‰©å±•æ€§** - æ”¯æŒæ›´å¤šå¹¶å‘ç”¨æˆ·

ç°åœ¨ç³»ç»Ÿå¯ä»¥å®‰å…¨å¤„ç†å¤šäººåŒæ—¶æŠ½ç­¾çš„åœºæ™¯ï¼ğŸ‰